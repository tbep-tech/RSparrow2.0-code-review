---
title: "*RSPARROW* v2.0 code review"
format: pdf
editor: source
author: Marcus W. Beck
date: today
date-format: medium
---

Thanks again for the opportunity to conduct the code review of *RSPARROW* v2.0.  I believe this will be an incredibly valuable piece of software for the water management community and I commend the team for adapting the tool to an open source environment. I also appreciate the responsiveness to my comments provided during beta testing of v2.0, in particular the removal of the *maptools* and *rgdal* dependencies, including use of a version of *sp* that does not require *rgdal*.  

The master branch containing *RSPARROW* v2.0 was downloaded to my personal computer on September 26th.  I installed the downloaded version as before during beta testing by creating an RStudio project in the unzipped directory and downloading the required dependencies following the R console prompts after running `devtools::load_all('RSPARROW_master')`.  Also note that my beta testing used R version 4.2.3 and my current R installation uses v4.3.1, as was included in the repository.  

The remainder of this document provides the code review after running the calibrated total phosphorus model for Tampa Bay, as used in the file *UserTutorialDynamic/results/sparrow_control.R*. I have also used the ROpenSci review template.  Items not marked are elaborated on in the review comments.  

## Package Review

- **Briefly describe any working relationship you have (had) with the package authors.** I have been involved with this project since 2019 as an end user at the Tampa Bay Estuary Program.  My involvement has been testing development versions of *RSPARROW* and sharing these tools with our management conference.
- [x] As the reviewer I confirm that there are no [conflicts of interest](https://devguide.ropensci.org/policies.html#coi) for me to review this work.

#### Documentation

The package includes all the following forms of documentation:

- [x] **A statement of need:** clearly stating problems the software is designed to solve and its target audience in README
- [x] **Installation instructions:** for the development version of package and any non-standard dependencies in README
- [x] **Vignette(s):** demonstrating major functionality that runs successfully locally
- [x] **Function Documentation:** for all exported functions
- [ ] **Examples:** (that run successfully locally) for all exported functions
- [x] **Community guidelines:** including contribution guidelines in the README or CONTRIBUTING, and DESCRIPTION with `URL`, `BugReports` and `Maintainer` (which may be autogenerated via `Authors@R`).

#### Functionality

- [x] **Installation:** Installation succeeds as documented.
- [x] **Functionality:** Any functional claims of the software been confirmed.
- [x] **Performance:** Any performance claims of the software been confirmed.
- [ ] **Automated tests:** Unit tests cover essential functions of the package and a reasonable range of inputs and conditions. All tests pass on the local machine.
- [ ] **Packaging guidelines**: The package conforms to the rOpenSci packaging guidelines.

Estimated hours spent reviewing:

- [x] Should the author(s) deem it appropriate, I agree to be acknowledged as a package reviewer ("rev" role) in the package DESCRIPTION file.

---

### Review Comments

#### Code issues

There are several .Rmd files in the R folder.

sf use


#### Versioning

I noticed some potential issues with the versioning used by *RSPARROW*.    Since this code review is meant to cover changes in version 2.0 compared to the previous, I was hoping to find some information in the version control on GitLab to easily compare 2.0 with previous versions.  There wasn't anything obvious in the repository indicating the version releases, nor were there any clear indications in the commit logs or repository graphs.  The only reference I found to previous versioning was a tag for v1.0.0 on a commit from [October 2019](https://code.usgs.gov/lgormansanisaca/rsparrow/-/commit/877b968bd04453a2102a78e28c6c02bb3e3faef0).  The previous code review by L. Platt was for version 1.1 and I could not find any indication in the repository where this version ended and where version 2.0 started.  Could the authors retroactively tag the different versions in the commit log? Or alternatively provide a change log between the versions (example from [dplyr](https://cran.r-project.org/web/packages/dplyr/news/news.html))? The latter would be a good addition to the user manual.

#### Considerations for future versions

Most of my comments relate to expected future developments of *RSPARROW* and, as such, do not need to be addressed at this time.  I provide them here for consideration for the developers moving forward.  

I strongly encourage that *RSPARROW* be developed as a standalone package made available on CRAN.  The user workflow for downloading, installing, and using the package is unconventional compared to a vast majority of other R packages.  I realize the current design was intentional given the large number of dependencies, both for R packages and supporting datasets for calibrated models.  However, the workflow required by this format is unfamiliar to most R users and there will be a substantial learning curve to using the model (although, again, I commend the authors for providing sufficiently detailed documentation in the user manual).  If the authors are able to further develop *RSPARROW* as a standalone R package, the following could be more easily implemented: 

* More complete function documentation: Although the functions include typical components of Roxygen documentation (e.g., function title, parameter descriptions, etc.), many other components are missing, such as example code or details on the returned values.  
* Limit the number of R package dependencies: Although there is no hardset rule, most R packages include no more than ten or so dependencies in the DESCRIPTION file.  *RSPARROW* v2.0 includes 40 R packages in the depends field.  This not only increases installation time, it also makes *RSPARROW* vulnerable to missing packages.  It is not uncommon for packages to be removed from CRAN or existing dependencies have newer versions with breaking changes.  *RSPARROW* will have a greater chance of being successfully maintained and usable in the future if the authors can greatly reduce the number of dependencies.  Perhaps start by identifying which dependencies are used the least and determining if they are absolutely necessary.  Sometimes entire functions from other packages can be copied/reused in the current package to remove a dependency.
* Add unit tests: I know this was mentioned by L. Platt, but I also encourage the authors to include specific unit tests (using [testthat](https://testthat.r-lib.org/)) to provide greater assurance that the code does what it's intended to do. I realize that the user tutorial models are compared using `compareModels()`, which is sufficient for version 2.0, but a future version could use the more conventional unit tests that are common in R packages. 
* Future versions of *RSPARROW* could migrate to GitHub since the source code for the current version on GitLab can only be viewed by verified users.  This might only be possible once *RSPARROW* is developed as a bona fide R package with minimal file sizes (i.e., most R packages are typically less than 5 MB). This would also streamline any community feedback in the issues (as currently suggested at <https://github.com/USGS-R/RSPARROW/issues>) by linking code changes in response to bug reports or enhancement requests.  
* Lastly, a working TN model would be greatly appreciated for Tampa Bay end users.  I know this isn't really a comment about the code, nor is this entirely within the control of the package developers, but the *RSPARROW* model will have the greatest impact in our region if we can better understand TN loads and inputs.  Our estuary is not phosphorus-limited, so the current tutorial models are of limited use for understanding nutrient impacts on water quality.  